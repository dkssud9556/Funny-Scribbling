# Execution Context

다른 언어에서 콜 스택이라는 것을 들어보았을 것이다. 이 콜 스택은 보통 함수의 호출 정보가 쌓여있는 스택을 의미한다. 자바스크립트의 실행 컨텍스트도 이와 비슷하다.

## 실행 컨텍스트란? 

ECMAScript에서는 실행 컨텍스트를 **"실행 가능한 코드를 형상화하고 구분하는 추상적인 개념"**으로 기술하고 있다. 실행 컨텍스트를 콜 스택과 연관지어 정의하면 "실행 가능한 자바스크립트 코드 블록이 실행되는 환경"이라고 할 수 있다. 실행 컨텍스트는 **실행에 필요한 여러 정보를 담고 있다.**

자바스크립트에서 실행 컨텍스트를 형성하는 경우가 세 가지 있다.

1. 전역 코드 -&gt; 가장 먼저 실행되는 실행 컨텍스트.
2. eval\(\) 함수로 실행되는 코드 
3. 함수 호출 

이 세 가지가 있지만 개발자는 대부분 함수로 실행 컨텍스트를 생성한다. 실행 컨텍스트가 생성되고, 생성된 실행 컨텍스트는 스택 안에 쌓인다. 당연하지만 스택의 제일 위에 위치한 실행 컨텍스트가 현재 실행중인 실행 컨텍스트이다.

> 현재 실행되는 컨텍스트에서 이 컨텍스트와 관련 없는 실행 코드가 실행되면, 새로운 컨텍스트가 생성되어 스택에 들어가고 제어권이 그 컨텍스트로 이동한다. - ECMAScript -

## 실행 컨텍스트 생성 과정 

### 1. 활성 객체 생성 

실행 컨텍스트는 코드 실행에 필요한 여러 정보를 가지고 있다고 했다. 여러 정보를 저장하는 객체가 생성돼야 하는데 이 객체를 활성 객체라고 한다. 사용자는 이 활성 객체에 접근할 수 없다.

### 2. arguments 객체 생성 

활성 객체는 arguments 프로퍼티로 arguments 객체를 참조한다.

### 3. 스코프 정보 생성 

현재 컨텍스트의 유효 범위를 나타내는 스코프 정보를 생성한다. 이 스코프 정보는 연결 리스트와 유사한 형태로 만들어지며, 이 리스트를 통해서 현재 컨텍스트에 없는 변수를 접근할 수 있다.

이 스코프 정보는 \[\[scope\]\] 프로퍼티로 참조된다.

### 4. 변수 생성 

현재 실행 컨텍스트에서 사용되는 변수를 생성하는 과정이다. ECMAScript에서는 변수 객체에 저장된다고 하지만 실제로는 활성 객체에 저장이 된다고 한다. 즉, 변수 객체라는 개념이 나오면 활성 객체와 동등하게 보면 된다는 것이다.

이 변수 객체에 함수를 호출할 때 넘긴 인자 값들이 만들어지고 값이 할당된다. 

주의할 점은 이 과정에서 해당 컨텍스트에서 사용될 지역 변수도 생성은 되지만, 초기화는 해당 표현식이 실행되기 전까지 이루어지지 않는다는 점이다.

### 5. this 바인딩 

함수 부분에서 설명한 규칙대로 this가 바인딩된다.

### 6. 코드 실행 

말 그대로 함수 바디에 있는 코드들이 실행된다.

## 전역 실행 컨텍스트 

전역 실행 컨텍스트는 일반적인 실행 컨텍스트와 조금 다르다. 전역 실행 컨텍스트는 arguments 객체를 가지고 있지 않고, 전역 객체만 포함하는 스코프 체인이 있다.

전역 실행 컨텍스트는 변수를 초기화하고 전역 실행 컨텍스트의 내부 함수는 일반적인 탑 레벨의 함수로 선언된다. 또한 전역 실행 컨텍스트의 변수 객체가 전역 객체로 사용된다.

### 브라우저와 Node.JS의 전역 객체 차이점 

브라우저에서는 window라는 전역 객체를 사용하며, 최상위 코드에서 선언한 변수가 window 객체의 프로퍼티로 등록된다.

```text
// 브라우저 
var str = 'Browser';
str2 = 'browser';

window.str; // Browser
window.str2; // browser
```

하지만 Node.JS에서는 window가 아닌 global이라는 전역 객체를 사용하며, 최상위 코드에서 선언한 변수가 global 객체의 프로퍼티로 등록되지 않는다. 왜냐하면 Node.JS는 js 파일에 따라서 모듈 스코프를 둬서, 어떤 js 파일에서 최상위 코드에 변수를 선언해도 global 객체에 등록되는 것이 아니라 그 js 파일의 지역 변수가 된다. global에 프로퍼티를 등록하고 싶다면 var 없이 변수를 선언하면 된다. 하지만 굳이 하지 않는 것이 좋다.

```text
// Node.JS
var str = 'Node.JS';
str2 = 'node.JS';

global.str; // undefined
global.str2; // node.JS
```

## 스코프 체인 

C, Java와 같은 언어에서 변수의 유효 범위는 중괄호로 묶여있는 범위다. 함수의 중괄호뿐만 아니라 if, for문의 중괄호도 변수의 유효 범위를 결정한다. 하지만 자바스크립트에서 if, for문 등의 중괄호는 유효 범위가 없다. 오직 함수만이 유효 범위의 한 단위가 된다. 유효 범위를 나타내는 스코프가 \[\[scope\]\] 프로퍼티로 각 함수 객체 내에서 연결 리스트 형식으로 관리되며, 이를 스코프 체인이라고 한다.

### 전역 실행 컨텍스트 

```text
var str = 'JavaScript';
var num = 50;
console.log(str); // JavaScript
console.log(num); // 50
```

이 코드는 전역 코드이기 때문에 스코프 체인의 제일 최상위에 있다. 따라서 상위 스코프가 존재하지 않으며, \[\[scope\]\] 프로퍼티는 자기 자신을 가리킨다. 

### 함수 호출 시 실행 컨텍스트 

```text
var value = 'global';
function func() {
    var value = 'local';
    console.log(value); // local
}
func();
console.log(value); // global
```

이 코드는 전역 컨텍스트가 만들어진 후에 func 함수의 컨텍스트가 만들어진다. func 함수의 스코프 체인은 실행된 함수의 \[\[scope\]\] 프로퍼티를 그대로 복사한 후, 현재 생성된 변수 객체를 복사한 스코프 체인의 맨 앞에 추가한다. 따라서 func 실행 컨텍스트의 스코프 체인은 \(func 변수 객체 -&gt; 전역 객체\)가 된다. 먼저 스코프 체인의 맨 앞에 위치한 변수 객체인 func 변수 객체에서 value 변수를 찾는데, value 변수가 존재하기 때문에 'local'이 담긴 value를 참조한다. 만약 func 변수 객체에 value 변수가 존재하지 않으면 스코프 체인을 따라서 전역 객체에서 value 변수를 탐색한다.

